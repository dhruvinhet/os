#include<semaphore.h>
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<pthread.h>

sem_t mutex, wrt;

int sharedvar = 99;

pthread_t writers[5], readers[5];

int readerscount = 0;

void writer(){
    printf("\n[Writer] Trying to enter...");
    fflush(stdout);

    sem_wait(&wrt);

    printf("\n[Writer] ENTER critical section");
    sharedvar++;
    printf("\n[Writer] Updated sharedvar to %d", sharedvar);

    sem_post(&wrt);
    printf("\n[Writer] EXIT critical section");
    fflush(stdout);
}

void reader(){
    printf("\n[Reader] Trying to enter...");
    fflush(stdout);

    sem_wait(&mutex);
    readerscount++;
    if(readerscount == 1){
        // first reader blocks writers
        sem_wait(&wrt);
    }
    sem_post(&mutex);

    printf("\n[Reader] ACTIVE (readers = %d) | sharedvar = %d", readerscount, sharedvar);
    printf("\n[Reader] Done reading");
    fflush(stdout);

    sem_wait(&mutex);
    readerscount--;
    if(readerscount == 0){
        // last reader unblocks writers
        sem_post(&wrt);
    }
    sem_post(&mutex);
}

int main(){
    int n2, i;
    printf("Enter number of readers and writers: ");
    scanf("%d", &n2);

    sem_init(&wrt, 0, 1);
    sem_init(&mutex, 0, 1);

    for(i = 0; i < n2; i++){
        pthread_create(&writers[i], NULL, (void *)writer, NULL);
        pthread_create(&readers[i], NULL, (void *)reader, NULL);
    }

    for(i = 0; i < n2; i++){
        pthread_join(writers[i], NULL);
        pthread_join(readers[i], NULL);
    }

    printf("\nFinal value of sharedvar = %d\n", sharedvar);
    return 0;
}
