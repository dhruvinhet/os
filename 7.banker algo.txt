#include <stdio.h>
#include <stdbool.h>

#define P 5  
#define R 3  

bool isSafe(int processes[], int avail[], int max[][R], int alloc[][R], int need[][R]) {
    int work[R];
    bool finish[P] = {false};
    int safeSeq[P];
    int count = 0;

    for (int i = 0; i < R; i++)
        work[i] = avail[i];

    while (count < P) 
    {
        bool found = false;
        for (int p = 0; p < P; p++) 
        {
            if (!finish[p]) 
            {
                int j;
                for (j = 0; j < R; j++)
                    if (need[p][j] > work[j])
                        break;

                if (j == R) 
                {
                    for (int k = 0; k < R; k++)
                        work[k] += alloc[p][k];
                    safeSeq[count++] = p;
                    finish[p] = true;
                    found = true;
                }
            }
        }
        if (!found) 
        {
            printf("System is NOT in safe state.\n");
            return false;
        }
    }

    printf("System is in safe state.\nSafe sequence is: ");
    for (int i = 0; i < P; i++) 
    {
        printf("P%d", safeSeq[i]);
        if (i != P - 1) printf(" -> ");
    }
    printf("\n");
    return true;
}


int main() 
{
    int processes[P] = {0, 1, 2, 3, 4};

    int alloc[P][R] = 
    {
        {0, 1, 0},  
        {2, 0, 0},  
        {3, 0, 2},  
        {2, 1, 1},  
        {0, 0, 2}   
    };

    int max[P][R] = 
    {
        {7, 5, 3},  
        {3, 2, 2},  
        {9, 0, 2},  
        {2, 2, 2},  
        {4, 3, 3}   
    };

    int avail[R] = {3, 3, 2};
    int need[P][R];
    for (int i = 0; i < P; i++)
        for (int j = 0; j < R; j++)
            need[i][j] = max[i][j] - alloc[i][j];

    printf("Initial ");
    if (!isSafe(processes, avail, max, alloc, need))
        return 0;

    int p;
    printf("\nEnter process number requesting resources (0-%d): ", P - 1);
    scanf("%d", &p);

    int request[R];
    printf("Enter request for resources A B C: ");
    for (int i = 0; i < R; i++)
        scanf("%d", &request[i]);


    for (int i = 0; i < R; i++) 
    {
        if (request[i] > need[p][i]) 
        {
            printf("Error: Request exceeds the process's maximum need.\n");
            return 0;
        }
    }

    for (int i = 0; i < R; i++) 
    {
        if (request[i] > avail[i]) 
        {
            printf("Resources not available. Process must wait.\n");
            return 0;
        }
    }

    for (int i = 0; i < R; i++) 
    {
        avail[i] -= request[i];
        alloc[p][i] += request[i];
        need[p][i] -= request[i];
    }

    printf("\nAfter allocation ");
    if (isSafe(processes, avail, max, alloc, need)) 
    {
        printf("Request granted.\n");
    } 
    else 
    {
        for (int i = 0; i < R; i++) 
        {
            avail[i] += request[i];
            alloc[p][i] -= request[i];
            need[p][i] += request[i];
        }
        printf("Request denied to avoid unsafe state.\n");
    }
    return 0;
}
